<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="Peng." />
    
    <title>Nginx 平滑升级</title>
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1">
    <link href="/atom.xml" rel="alternate" title="Peng's Blog" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/style.css">
    <link rel="stylesheet" href="/media/css/github.css">
    <link rel="stylesheet" href="/media/css/fontawesome.css">
    <script src="/media/js/jquery-1.7.1.min.js" type="text/javascript" charset="utf-8"></script> 
    <script type="text/javascript" src="/media/js/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </head>
  <body>
      <div id="main" role="main">
        <header>
          <div id="header">
            <h1><a title="Peng's Blog" class="" href="/">Peng's Blog</a></h1>
          </div>
          <nav>
            
            <span><a title="Archive" href="/archive.html"><i class="fa fa-list-ul"></i></a></span>
            
            <span><a title="Tags" href="/tags.html"><i class="fa fa-tags"></i></a></span>
            
            <span><a title="About" href="/about.html"><i class="fa fa-user"></i></a></span>
            
          </nav>
        </header>
        <div id="content">
        <article>
  <section class="title">
    <h2>Nginx 平滑升级 </h2>
  </section>
  <section class="meta">
  <span class="time">
    <time datetime="2014-07-02">2014-07-02</time>
  </span>
  
  <span class="tags">
    
    <a href="/tags.html#nginx" title="nginx">#nginx</a>
    
  </span>
  
  </section>
  <section class="post">
  <p>Nginx作为Web服务器的后起之秀，因其显著的性能，越来越受到企业的青睐，众多大型网站都从Apache迁移到Nginx，淘宝更是在其基础上发起了<a href="http://tengine.taobao.org/">Tengine</a>开源项目，可见Nginx在Web服务器中地位之重。</p>

<p>Web服务器作为用户请求后端服务器的入口，不单只负责建立连接，处理请求，还承担着“守门卫”的安全职责。从安全角度来说，Nginx本身的安全性十分重要，因此必须时刻关注Nginx的安全升级补丁。</p>

<p>本篇文章主要介绍“如何在不影响用户访问的情况下平滑升级Nginx”。</p>

<hr />

<p>下载nginx最新稳定版， 这里以0.7升级到1.4.1为例： <a href="http://nginx.org/download/">[下载地址]</a></p>

<pre><code class="bash">$ wget "http://nginx.org/download/nginx-1.4.1.tar.gz"
$ tar zxvf nginx-1.4.1.tar.gz   #解压
</code></pre>

<p>查看当前已安装的nginx版本的编译参数（configure arguments）：</p>

<pre><code class="bash">$ nginx -V
nginx version: nginx/0.7.67
TLS SNI support enabled
configure arguments: --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log 
--http-client-body-temp-path=/var/lib/nginx/body 
--http-fastcgi-temp-path=/var/lib/nginx/fastcgi 
--http-log-path=/var/log/nginx/access.log 
--http-proxy-temp-path=/var/lib/nginx/proxy 
--lock-path=/var/lock/nginx.lock 
--pid-path=/var/run/nginx.pid 
--with-debug --with-http_dav_module --with-http_flv_module 
--with-http_geoip_module --with-http_gzip_static_module 
--with-http_realip_module --with-http_stub_status_module 
--with-http_ssl_module --with-http_sub_module 
--with-ipv6 --with-mail --with-mail_ssl_module 
--add-module=/build/buildd/nginx-0.7.67/modules/nginx-upstream-fair
</code></pre>

<p>根据旧版本的编译参数重新编译新版本：</p>

<pre><code class="bash">$ cd nginx-1.4.1

$ ./configure --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log 
--http-client-body-temp-path=/var/lib/nginx/body 
--http-fastcgi-temp-path=/var/lib/nginx/fastcgi 
--http-log-path=/var/log/nginx/access.log 
--http-proxy-temp-path=/var/lib/nginx/proxy
--lock-path=/var/lock/nginx.lock
--pid-path=/var/run/nginx.pid
--with-debug --with-http_dav_module --with-http_flv_module 
--with-http_geoip_module --with-http_gzip_static_module 
--with-http_realip_module --with-http_stub_status_module 
--with-http_ssl_module --with-http_sub_module 
--with-ipv6 --with-mail --with-mail_ssl_module

$ make      #编译，编译后这里不要执行make install，后面手动安装
</code></pre>

<p>P.S: 编译过程中可能会出现缺少xxx libary的情况， 可参考<a href="http://blog.linuxphp.org/archives/1430/">这遍文章</a>来安装缺少的lib。</p>

<p>编译完成后，替换 nginx 二进制文件。</p>

<pre><code class="bash">$ sudo mv /usr/sbin/nginx  /usr/sbin/nginx.old  #备份旧文件， 具体路径可能有所不同， 可以通过命令which nginx查看）
$ sudo cp objs/nginx /usr/sbin/nginx    #替换为新编译的nginx
$ sudo /usr/sbin/nginx -t               #测试是否正常
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: [emerg] mkdir() "/usr/local/nginx/uwsgi_temp" failed (2: No such file or directory)
nginx: configuration file /etc/nginx/nginx.conf test failed
</code></pre>

<p>提示/usr/local/nginx目录不存在，创建该目录：</p>

<pre><code>$ sudo mkdir /usr/local/nginx
</code></pre>

<p>再次测试，一切正常：</p>

<pre><code class="bash">$ sudo /usr/sbin/nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
</code></pre>

<p>启动新进程，关闭旧进程：</p>

<pre><code>$ sudo kill -USR2 `cat /var/run/nginx.pid` #pid的文件路径可以参考第一步 nginx -V 的pid-path
</code></pre>

<p>执行完上一步后，nginx会把 <em>nginx.pid</em> 备份成 <em>nginx.pid.oldbin</em>，并启动新的nginx进程接收用户请求。</p>

<p>平滑关闭旧进程：</p>

<pre><code>$ sudo kill -QUIT `cat /var/run/nginx.pid.oldbin`  
</code></pre>

<p><strong>升级完成：</strong></p>

<pre><code>$ nginx -V
nginx version: nginx/1.4.1
built by gcc 4.4.7 (Ubuntu/Linaro 4.4.7-1ubuntu2) 
TLS SNI support enabled
configure arguments: --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-client-body-temp-path=/var/lib/nginx/body --http-fastcgi-temp-path=/var/lib/nginx/fastcgi --http-log-path=/var/log/nginx/access.log --http-proxy-temp-path=/var/lib/nginx/proxy --lock-path=/var/lock/nginx.lock --pid-path=/var/run/nginx.pid --with-debug --with-http_dav_module --with-http_flv_module --with-http_gzip_static_module --with-http_realip_module --with-http_stub_status_module --with-http_ssl_module --with-http_sub_module --with-ipv6 --with-mail --with-mail_ssl_module
</code></pre>

<p>建议在整个升级过程中，运行一个脚本不断访问升级的网站，检测是否会出现服务中断的现象。</p>

<pre><code>#!/bin/bash

while [ 0 ]
do
    curl -I 'http://localhost:80/'
    sleep 1
done
</code></pre>

<p>附其他参考资料：</p>

<blockquote><p>http://blog.sina.com.cn/s/blog_537977e50100i1hz.html</p>

<p>http://weizhifeng.net/nginx-signal-processing-and-upgrade.html</p>

<p>http://www.vpsee.com/2011/03/install-nginx-with-geoip-module-for-country-targeting/</p>

<p>http://blog.linuxphp.org/archives/1430/</p></blockquote>

  </section>
  
</article>

        </div>
        <footer>
          <div>
            
            &copy; 2014 ~ 2014 Peng. | powered by jekyll | themed by <a href="http://lhzhang.com" title="sext vi" target="_blank">sext vi</a> | fork <a href="https://github.com/waynezhang/blog" title="fork me" target="_blank">me</a>
          </div>
        </footer>
      </div> <!-- main -->
  </body>
</html>
